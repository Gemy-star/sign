{% extends 'base.html' %}
{% load static %}

{% block title %}تفاصيل الاشتراك #{{ subscription.id }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title fade-in">
                <i class="fas fa-file-invoice"></i> تفاصيل الاشتراك #{{ subscription.id }}
            </h1>
            <p class="page-subtitle">معلومات تفصيلية عن الاشتراك</p>
        </div>
        <a href="{% url 'dashboard:subscriptions' %}" class="btn btn-outline">
            <i class="fas fa-arrow-right"></i> العودة
        </a>
    </div>
</div>

<!-- Subscription Info Cards -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card scale-in" style="border: none; box-shadow: var(--shadow-md); border-radius: var(--border-radius-lg);">
            <div class="card-body p-4">
                <h3 class="h5 fw-bold mb-4" style="color: var(--color-secondary);">
                    <i class="fas fa-info-circle"></i> معلومات الاشتراك
                </h3>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">المستخدم</label>
                        <div class="d-flex align-items-center mt-2">
                            <div class="user-avatar me-2" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--color-primary), var(--color-accent));">
                                {{ subscription.user.username|slice:":1"|upper }}
                            </div>
                            <div>
                                <strong style="font-size: 1.1rem;">{{ subscription.user.get_full_name|default:subscription.user.username }}</strong><br>
                                <small class="text-muted">{{ subscription.user.email }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">الباقة</label>
                        <div class="mt-2">
                            <h4 style="color: var(--color-primary); margin-bottom: 0.5rem;">{{ subscription.package.name }}</h4>
                            <p class="text-muted mb-0">{{ subscription.package.description }}</p>
                            <div class="mt-2">
                                <span class="badge" style="background: linear-gradient(135deg, var(--color-primary), var(--color-accent)); color: white; padding: 0.5rem 1rem;">
                                    <i class="fas fa-dollar-sign"></i> ${{ subscription.package.price }} / {{ subscription.package.get_duration_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="text-muted small">الحالة</label>
                        <div class="mt-2">
                            {% if subscription.status == 'active' %}
                                <span class="badge badge-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-check-circle"></i> نشط
                                </span>
                            {% elif subscription.status == 'expired' %}
                                <span class="badge badge-warning" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-clock"></i> منتهي
                                </span>
                            {% elif subscription.status == 'cancelled' %}
                                <span class="badge badge-danger" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-times-circle"></i> ملغي
                                </span>
                            {% elif subscription.status == 'pending' %}
                                <span class="badge badge-info" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-hourglass-half"></i> قيد الانتظار
                                </span>
                            {% else %}
                                <span class="badge badge-danger" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-exclamation-circle"></i> فشل الدفع
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="text-muted small">تاريخ البداية</label>
                        <div class="mt-2">
                            {% if subscription.start_date %}
                                <strong>{{ subscription.start_date|date:"Y-m-d" }}</strong><br>
                                <small class="text-muted">{{ subscription.start_date|date:"H:i A" }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="text-muted small">تاريخ الانتهاء</label>
                        <div class="mt-2">
                            {% if subscription.end_date %}
                                <strong>{{ subscription.end_date|date:"Y-m-d" }}</strong><br>
                                <small class="text-muted">{{ subscription.end_date|date:"H:i A" }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="text-muted small">المبلغ المدفوع</label>
                        <div class="mt-2">
                            {% if subscription.amount_paid %}
                                <strong style="color: var(--color-success); font-size: 1.25rem;">${{ subscription.amount_paid }}</strong>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">رقم الدفع</label>
                        <div class="mt-2">
                            {% if subscription.payment_id %}
                                <code style="background: var(--color-bg-light); padding: 0.5rem; border-radius: 0.25rem;">{{ subscription.payment_id }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">طريقة الدفع</label>
                        <div class="mt-2">
                            {% if subscription.payment_method %}
                                <span class="badge badge-info">{{ subscription.payment_method }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">التجديد التلقائي</label>
                        <div class="mt-2">
                            {% if subscription.auto_renew %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check"></i> مفعّل
                                </span>
                            {% else %}
                                <span class="badge badge-danger">
                                    <i class="fas fa-times"></i> غير مفعّل
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">تاريخ الإنشاء</label>
                        <div class="mt-2">
                            <strong>{{ subscription.created_at|date:"Y-m-d H:i" }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card scale-in" style="border: none; box-shadow: var(--shadow-md); border-radius: var(--border-radius-lg); animation-delay: 0.1s;">
            <div class="card-body p-4">
                <h3 class="h5 fw-bold mb-4" style="color: var(--color-secondary);">
                    <i class="fas fa-bullseye"></i> المجالات المختارة
                </h3>

                {% if subscription.selected_scopes.all %}
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        {% for scope in subscription.selected_scopes.all %}
                            <div style="background: linear-gradient(135deg, rgba(235, 103, 42, 0.1), rgba(129, 91, 164, 0.1)); padding: 1rem; border-radius: var(--border-radius-md); border-right: 4px solid var(--color-primary);">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">{{ scope.icon }}</div>
                                <strong style="color: var(--color-text-dark);">{{ scope.name }}</strong><br>
                                <small class="text-muted">{{ scope.get_category_display }}</small>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>لم يتم اختيار مجالات</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- User Goals -->
{% if goals %}
<div class="card mb-4 fade-in">
    <div class="card-body p-4" style="border: none; box-shadow: var(--shadow-md); border-radius: var(--border-radius-lg);">
        <h3 class="h5 fw-bold mb-4" style="color: var(--color-secondary);">
            <i class="fas fa-bullseye"></i> أهداف المستخدم ({{ goals.count }})
        </h3>

        <div class="row">
            {% for goal in goals %}
            <div class="col-md-6 mb-3">
                <div style="background: var(--color-bg-light); padding: 1.25rem; border-radius: var(--border-radius-md); border-right: 4px solid {% if goal.status == 'completed' %}var(--color-success){% elif goal.status == 'active' %}var(--color-primary){% else %}var(--color-text-muted){% endif %};">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h4 class="h6 fw-bold mb-0">{{ goal.title }}</h4>
                        {% if goal.status == 'completed' %}
                            <span class="badge badge-success">مكتمل</span>
                        {% elif goal.status == 'active' %}
                            <span class="badge badge-info">نشط</span>
                        {% elif goal.status == 'paused' %}
                            <span class="badge badge-warning">متوقف</span>
                        {% else %}
                            <span class="badge badge-secondary">مؤرشف</span>
                        {% endif %}
                    </div>

                    {% if goal.description %}
                        <p class="text-muted small mb-3">{{ goal.description|truncatewords:20 }}</p>
                    {% endif %}

                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">التقدم</small>
                            <small><strong>{{ goal.progress_percentage }}%</strong></small>
                        </div>
                        <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--color-primary), var(--color-accent)); height: 100%; width: {{ goal.progress_percentage }}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>

                    {% if goal.target_date %}
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> الموعد المستهدف: {{ goal.target_date }}
                        </small>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Messages -->
{% if messages %}
<div class="card mb-4 fade-in">
    <div class="card-body p-0" style="border: none; box-shadow: var(--shadow-md); border-radius: var(--border-radius-lg);">
        <div class="p-4 border-bottom">
            <h3 class="h5 fw-bold mb-0" style="color: var(--color-secondary);">
                <i class="fas fa-comments"></i> آخر الرسائل ({{ messages.count }})
            </h3>
        </div>

        <div style="max-height: 400px; overflow-y: auto;">
            {% for message in messages %}
            <div class="p-4 border-bottom" style="transition: background 0.2s;">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex gap-2">
                        {% if message.message_type == 'daily' %}
                            <span class="badge badge-info">يومي</span>
                        {% elif message.message_type == 'goal_specific' %}
                            <span class="badge badge-success">هدف محدد</span>
                        {% elif message.message_type == 'scope_based' %}
                            <span class="badge badge-warning">مجال</span>
                        {% else %}
                            <span class="badge badge-secondary">مخصص</span>
                        {% endif %}

                        {% if message.scope %}
                            <span class="badge badge-primary">{{ message.scope.icon }} {{ message.scope.name }}</span>
                        {% endif %}
                    </div>
                    <small class="text-muted">{{ message.created_at|date:"Y-m-d H:i" }}</small>
                </div>

                <p class="mb-2">{{ message.content|truncatewords:30 }}</p>

                <div class="d-flex gap-3 align-items-center">
                    {% if message.user_rating %}
                        <div>
                            <i class="fas fa-star" style="color: #ffc107;"></i>
                            <strong>{{ message.user_rating }}/5</strong>
                        </div>
                    {% endif %}

                    {% if message.is_favorited %}
                        <span class="badge badge-warning">
                            <i class="fas fa-heart"></i> مفضلة
                        </span>
                    {% endif %}

                    <small class="text-muted">
                        <i class="fas fa-robot"></i> {{ message.ai_model }}
                    </small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Payment Transactions -->
{% if transactions %}
<div class="card fade-in">
    <div class="card-body p-0" style="border: none; box-shadow: var(--shadow-md); border-radius: var(--border-radius-lg);">
        <div class="p-4 border-bottom">
            <h3 class="h5 fw-bold mb-0" style="color: var(--color-secondary);">
                <i class="fas fa-credit-card"></i> سجل المعاملات ({{ transactions.count }})
            </h3>
        </div>

    <div class="table-responsive table-responsive-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>رقم المعاملة</th>
                        <th>المبلغ</th>
                        <th>الحالة</th>
                        <th>طريقة الدفع</th>
                        <th>التاريخ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>
                            <code style="background: var(--color-bg-light); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.813rem;">
                                {{ transaction.tap_charge_id }}
                            </code>
                        </td>
                        <td>
                            <strong style="color: var(--color-success);">${{ transaction.amount }} {{ transaction.currency }}</strong>
                        </td>
                        <td>
                            {% if transaction.status == 'completed' %}
                                <span class="badge badge-success">مكتمل</span>
                            {% elif transaction.status == 'processing' %}
                                <span class="badge badge-info">قيد المعالجة</span>
                            {% elif transaction.status == 'failed' %}
                                <span class="badge badge-danger">فشل</span>
                            {% elif transaction.status == 'refunded' %}
                                <span class="badge badge-warning">مسترد</span>
                            {% else %}
                                <span class="badge badge-secondary">مبدئي</span>
                            {% endif %}
                        </td>
                        <td>{{ transaction.payment_method|default:"-" }}</td>
                        <td>{{ transaction.created_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
