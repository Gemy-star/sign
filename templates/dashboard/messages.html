{% extends 'base.html' %}
{% load static %}

{% block title %}الرسائل{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title fade-in">
        <i class="fas fa-comments"></i> الرسائل التحفيزية
    </h1>
    <p class="page-subtitle">إدارة الرسائل المولدة بواسطة الذكاء الاصطناعي</p>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
        <div class="stat-header">
            <div class="stat-icon primary">
                <i class="fas fa-comment-dots"></i>
            </div>
        </div>
        <div class="stat-value">{{ messages.count }}</div>
        <div class="stat-label">إجمالي الرسائل</div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
        <div class="stat-header">
            <div class="stat-icon info">
                <i class="fas fa-sun"></i>
            </div>
        </div>
        <div class="stat-value">{{ type_counts.daily|default:0 }}</div>
        <div class="stat-label">رسائل يومية</div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card fade-in" style="animation-delay: 0.3s;">
        <div class="stat-header">
            <div class="stat-icon success">
                <i class="fas fa-bullseye"></i>
            </div>
        </div>
        <div class="stat-value">{{ type_counts.goal_specific|default:0 }}</div>
        <div class="stat-label">رسائل الأهداف</div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card fade-in" style="animation-delay: 0.4s;">
        <div class="stat-header">
            <div class="stat-icon warning">
                <i class="fas fa-star"></i>
            </div>
        </div>
        <div class="stat-value">{{ avg_rating|floatformat:1 }}</div>
        <div class="stat-label">متوسط التقييم</div>
    </div>
</div>

<!-- Filter Buttons -->
<div class="mb-4">
    <div class="btn-group" role="group">
        <a href="{% url 'dashboard:messages' %}" class="btn {% if not message_type %}btn-primary{% else %}btn-outline{% endif %}">
            <i class="fas fa-list"></i> الكل
        </a>
        <a href="?type=daily" class="btn {% if message_type == 'daily' %}btn-primary{% else %}btn-outline{% endif %}">
            <i class="fas fa-sun"></i> يومي
            <span class="badge" style="background: white; color: var(--color-info); margin-right: 0.5rem;">
                {{ type_counts.daily|default:0 }}
            </span>
        </a>
        <a href="?type=goal_specific" class="btn {% if message_type == 'goal_specific' %}btn-primary{% else %}btn-outline{% endif %}">
            <i class="fas fa-bullseye"></i> أهداف
            <span class="badge" style="background: white; color: var(--color-success); margin-right: 0.5rem;">
                {{ type_counts.goal_specific|default:0 }}
            </span>
        </a>
        <a href="?type=scope_based" class="btn {% if message_type == 'scope_based' %}btn-primary{% else %}btn-outline{% endif %}">
            <i class="fas fa-layer-group"></i> مجال
            <span class="badge" style="background: white; color: var(--color-warning); margin-right: 0.5rem;">
                {{ type_counts.scope_based|default:0 }}
            </span>
        </a>
        <a href="?type=custom" class="btn {% if message_type == 'custom' %}btn-primary{% else %}btn-outline{% endif %}">
            <i class="fas fa-magic"></i> مخصص
            <span class="badge" style="background: white; color: var(--color-secondary); margin-right: 0.5rem;">
                {{ type_counts.custom|default:0 }}
            </span>
        </a>
    </div>
</div>

<!-- Messages List -->
<div class="table-card fade-in">
    <div class="table-header">
        <h3 class="table-title">
            <i class="fas fa-table"></i>
            {% if message_type %}
                الرسائل - {{ message_type }}
            {% else %}
                جميع الرسائل
            {% endif %}
        </h3>
        <div class="d-flex gap-2">
            <input type="text" id="searchInput" class="form-control" placeholder="بحث..." style="max-width: 300px;">
        </div>
    </div>

    <div class="row p-4" id="messagesList">
        {% for message in messages %}
        <div class="col-lg-6 mb-4 message-item">
            <div class="card h-100 scale-in" style="border: none; box-shadow: var(--shadow-md); border-radius: var(--border-radius-lg); transition: all var(--transition-base); animation-delay: {{ forloop.counter0|divisibleby:10|yesno:'0.1,0.2,0.3,0.4,0.5' }}s;">
                <div class="card-body p-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="user-avatar" style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--color-primary), var(--color-accent));">
                                {{ message.user.username|slice:":1"|upper }}
                            </div>
                            <div>
                                <strong>{{ message.user.username }}</strong><br>
                                <small class="text-muted">{{ message.created_at|date:"Y-m-d H:i" }}</small>
                            </div>
                        </div>

                        <div class="d-flex flex-column gap-1 align-items-end">
                            {% if message.message_type == 'daily' %}
                                <span class="badge badge-info">
                                    <i class="fas fa-sun"></i> يومي
                                </span>
                            {% elif message.message_type == 'goal_specific' %}
                                <span class="badge badge-success">
                                    <i class="fas fa-bullseye"></i> هدف
                                </span>
                            {% elif message.message_type == 'scope_based' %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-layer-group"></i> مجال
                                </span>
                            {% else %}
                                <span class="badge badge-secondary">
                                    <i class="fas fa-magic"></i> مخصص
                                </span>
                            {% endif %}

                            {% if message.is_favorited %}
                                <span class="badge badge-danger">
                                    <i class="fas fa-heart"></i> مفضلة
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Scope/Goal Info -->
                    {% if message.scope or message.goal %}
                    <div class="mb-3">
                        {% if message.scope %}
                            <span class="badge badge-primary" style="font-size: 0.875rem; padding: 0.5rem 0.75rem;">
                                {{ message.scope.icon }} {{ message.scope.name }}
                            </span>
                        {% endif %}
                        {% if message.goal %}
                            <span class="badge" style="background: linear-gradient(135deg, var(--color-secondary), var(--color-purple-light)); color: white; font-size: 0.875rem; padding: 0.5rem 0.75rem;">
                                <i class="fas fa-target"></i> {{ message.goal.title }}
                            </span>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Message Content -->
                    <div class="mb-3" style="background: var(--color-bg-light); padding: 1rem; border-radius: var(--border-radius-md); border-right: 4px solid var(--color-primary);">
                        <p class="mb-0" style="line-height: 1.8;">{{ message.content }}</p>
                    </div>

                    <!-- Rating -->
                    {% if message.user_rating %}
                    <div class="mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <strong class="text-muted small">التقييم:</strong>
                            {% for i in "12345" %}
                                {% if forloop.counter <= message.user_rating %}
                                    <i class="fas fa-star" style="color: #ffc107;"></i>
                                {% else %}
                                    <i class="far fa-star" style="color: #cbd5e0;"></i>
                                {% endif %}
                            {% endfor %}
                            <span class="badge badge-warning">{{ message.user_rating }}/5</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- AI Info & Status -->
                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge" style="background: rgba(129, 91, 164, 0.1); color: var(--color-secondary);">
                                <i class="fas fa-robot"></i> {{ message.ai_model }}
                            </span>
                            {% if message.tokens_used %}
                                <span class="badge" style="background: rgba(235, 103, 42, 0.1); color: var(--color-primary);">
                                    <i class="fas fa-microchip"></i> {{ message.tokens_used }} tokens
                                </span>
                            {% endif %}
                            {% if message.is_read %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check"></i> مقروءة
                                </span>
                            {% else %}
                                <span class="badge badge-info">
                                    <i class="fas fa-envelope"></i> جديدة
                                </span>
                            {% endif %}
                        </div>

                        <button class="btn btn-sm btn-outline" onclick="togglePrompt({{ message.id }})">
                            <i class="fas fa-code"></i> عرض Prompt
                        </button>
                    </div>

                    <!-- Prompt (Hidden by default) -->
                    <div id="prompt-{{ message.id }}" style="display: none; margin-top: 1rem; padding: 1rem; background: #2d3748; color: #e2e8f0; border-radius: var(--border-radius-md); font-family: 'Courier New', monospace; font-size: 0.813rem; direction: ltr; text-align: left;">
                        <div style="color: #48bb78; margin-bottom: 0.5rem;">// Prompt Used:</div>
                        <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">{{ message.prompt_used }}</pre>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <h4>لا توجد رسائل</h4>
                <p class="text-muted">لم يتم العثور على أي رسائل</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toggle prompt display
    function togglePrompt(messageId) {
        const promptDiv = document.getElementById('prompt-' + messageId);
        if (promptDiv.style.display === 'none') {
            promptDiv.style.display = 'block';
        } else {
            promptDiv.style.display = 'none';
        }
    }

    // Search functionality
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const messageItems = document.querySelectorAll('.message-item');

        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const searchTerm = this.value.toLowerCase();

                for (const item of messageItems) {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        }

        // Add hover effect to message cards
        const cards = document.querySelectorAll('.message-item .card');
        for (const card of cards) {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = 'var(--shadow-xl)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'var(--shadow-md)';
            });
        }
    });
</script>
{% endblock %}
